############################
# zoom_saml_scim_demo.tf  #
############################

terraform {
  required_providers {
    okta = {
      source  = "okta/okta"
      version = ">= 5.0.0"
    }
  }
}

#####################################
# Provider variables (no hardcodes) #
#####################################
variable "org_name" {
  description = "Your Okta org subdomain (the part before .okta.com)"
  type        = string
}

variable "base_url" {
  description = "Okta domain suffix"
  type        = string
  default     = "okta.com"
}

variable "api_token" {
  description = "Okta API token"
  type        = string
  sensitive   = true
}

#####################
# Okta provider v5  #
#####################
provider "okta" {
  org_name  = var.org_name
  base_url  = var.base_url
  api_token = var.api_token
}

##########################################
# Zoom SAML app (SAML-only, v5 syntax)   #
##########################################
resource "okta_app_saml" "app_zoom_saml_scim_demo" {
  label               = "Zoom SAML SCIM Demo"

  # Zoom SP endpoints
  sso_url             = "https://zoom.us/saml/SSO"
  recipient           = "https://zoom.us/saml/SSO"
  destination         = "https://zoom.us/saml/SSO"
  audience            = "https://zoom.us"
  default_relay_state = ""

  response_signed              = true
  assertion_signed             = true
  signature_algorithm          = "RSA_SHA256"
  digest_algorithm             = "SHA256"
  honor_force_authn            = false
  authn_context_class_ref      = "urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport"

  # Zoom requires NameID = email (emailAddress format)
  subject_name_id_template     = "{{user.email}}"
  subject_name_id_format       = "urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress"

  # SLO optional for Zoom; issuer set to SP entity
  single_logout_issuer         = "https://zoom.us"
  single_logout_url            = ""
  single_logout_certificate    = <<-PEM
-----BEGIN CERTIFICATE-----
MIIDtDCCApygAwIBAgIGAZhpjENRMA0GCSqGSIb3DQEBCwUAMIGaMQswCQYDVQQG
EwJVUzETMBEGA1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEN
MAsGA1UECgwET2t0YTEUMBIGA1UECwwLU1NPUHJvdmlkZXIxGzAZBgNVBAMMEmludGVn
cmF0b3ItMTA2NzgwMjEcMBoGCSqGSIb3DQEJARYNaW5mb0Bva3RhLmNvbTCCASIwDQYJ
KoZIhvcNAQEBBQADggEPADCCAQoCggEBAL+iHMBdrkRY9EgXlfonsZI95te61jMM5QiC
X8nBBplZOcohbekKRRrQJ5VryLgj8wm5AXpun4IKYVvF7rwP8c6v2nHTar76ymQeUS3n
MwKtpffkUlQ7M7R/oiKEwTnU+5csxowOaOysEtj65EeBtV6mtVFBzMyxW63dzapKr7Av
D+5UMiqyYWPehPs9AuPVUDUuHhnQHNq+TnIOZ1JgtBSv7e4uUawO6A+Y9Maw0asyYTlw
yC16OhITejA0pihBxqDRvr+eMKdJH7DEGUpNIJU1XkBRhvCGOjxAmYIVAfNLcuG5Pdhj
4pe/qJ19GuL8W1N/skk5hgRnqYykCyQaBU0CAwEAATANBgkqhkiG9w0BAQsFAAOCAQEA
M4dKDWtN6IEVRMEYBe7Vj6rqnPBy8JW+9gtO/XjZauApQ4IwQnZ+wVLWSSRnYF66sZXC
nCEZ4ZQQijX+5E8iXNvI/kdyqKmm3j0sI7mF3e5pB+727Cgx1cPqt1EArLNrjhs09ZYZ
2YgAEH42zAPz8KG9hKxdd3EJqUh/tYQjXOwCtj6dnrPYjKbT8d5amqF3Odi5S+jUzh0i
03x21z5UA8LaasXLzBCSxtFG3QX0MABG/uzcCPJjdz9JrF1Lm9bn5185qPgYz+Te+3M+
Hio/3Qtp5FvyZJqXiRHphGldQihVGL2iBip+iDwJedNQmq/0gEuzXIVZPSEd+sKUYTnD
Mw==
-----END CERTIFICATE-----
PEM

  # v5.x: attribute_statements are blocks
  attribute_statements {
    name   = "Email"
    values = ["user.email"]
  }

  attribute_statements {
    name   = "FirstName"
    values = ["user.firstName"]
  }

  attribute_statements {
    name   = "LastName"
    values = ["user.lastName"]
  }
}

  # Zoom SP endpoints
  sso_url             = "https://zoom.us/saml/SSO"
  recipient           = "https://zoom.us/saml/SSO"
  destination         = "https://zoom.us/saml/SSO"
  audience            = "https://zoom.us"
  default_relay_state = ""

  response_signed     = true
  assertion_signed    = true
  signature_algorithm = "RSA_SHA256"
  digest_algorithm    = "SHA256"
  honor_force_authn   = false

  # Zoom requires NameID = email (emailAddress format)
  subject_name_id_template = "{{user.email}}"
  subject_name_id_format   = "urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress"

  # SLO optional for Zoom; issuer set to SP entity
  single_logout_issuer      = "https://zoom.us"
  single_logout_url         = ""
  single_logout_certificate = <<-PEM
-----BEGIN CERTIFICATE-----
MIIDtDCCApygAwIBAgIGAZhpjENRMA0GCSqGSIb3DQEBCwUAMIGaMQswCQYDVQQG
EwJVUzETMBEGA1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNjbzEN
MAsGA1UECgwET2t0YTEUMBIGA1UECwwLU1NPUHJvdmlkZXIxGzAZBgNVBAMMEmludGVn
cmF0b3ItMTA2NzgwMjEcMBoGCSqGSIb3DQEJARYNaW5mb0Bva3RhLmNvbTCCASIwDQYJ
KoZIhvcNAQEBBQADggEPADCCAQoCggEBAL+iHMBdrkRY9EgXlfonsZI95te61jMM5QiC
X8nBBplZOcohbekKRRrQJ5VryLgj8wm5AXpun4IKYVvF7rwP8c6v2nHTar76ymQeUS3n
MwKtpffkUlQ7M7R/oiKEwTnU+5csxowOaOysEtj65EeBtV6mtVFBzMyxW63dzapKr7Av
D+5UMiqyYWPehPs9AuPVUDUuHhnQHNq+TnIOZ1JgtBSv7e4uUawO6A+Y9Maw0asyYTlw
yC16OhITejA0pihBxqDRvr+eMKdJH7DEGUpNIJU1XkBRhvCGOjxAmYIVAfNLcuG5Pdhj
4pe/qJ19GuL8W1N/skk5hgRnqYykCyQaBU0CAwEAATANBgkqhkiG9w0BAQsFAAOCAQEA
M4dKDWtN6IEVRMEYBe7Vj6rqnPBy8JW+9gtO/XjZauApQ4IwQnZ+wVLWSSRnYF66sZXC
nCEZ4ZQQijX+5E8iXNvI/kdyqKmm3j0sI7mF3e5pB+727Cgx1cPqt1EArLNrjhs09ZYZ
2YgAEH42zAPz8KG9hKxdd3EJqUh/tYQjXOwCtj6dnrPYjKbT8d5amqF3Odi5S+jUzh0i
03x21z5UA8LaasXLzBCSxtFG3QX0MABG/uzcCPJjdz9JrF1Lm9bn5185qPgYz+Te+3M+
Hio/3Qtp5FvyZJqXiRHphGldQihVGL2iBip+iDwJedNQmq/0gEuzXIVZPSEd+sKUYTnD
Mw==
-----END CERTIFICATE-----
PEM

  # v5.x: attribute_statements are blocks
  attribute_statements {
    name   = "Email"
    values = ["user.email"]
  }

  attribute_statements {
    name   = "FirstName"
    values = ["user.firstName"]
  }

  attribute_statements {
    name   = "LastName"
    values = ["user.lastName"]
  }
}
